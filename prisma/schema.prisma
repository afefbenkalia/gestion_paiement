generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum Role {
  RESPONSABLE
  COORDINATEUR
  FORMATEUR
}

enum UserStatus {
  ACTIVE
  INACTIVE
}

model User {
  id        Int      @id @default(autoincrement())
  name      String
  email     String   @unique
  password  String
  cv        String?  @db.Text
  role      Role     @default(FORMATEUR)
  status    UserStatus @default(INACTIVE)
  specialite String?   @db.VarChar(150)
  fonction String?   @db.VarChar(150)
  cin       String?   @db.VarChar(8)
  rib       String?   @db.VarChar(20)
  banque    String?   @db.VarChar(200)
  tel       String?   @db.VarChar(8)
  createdAt DateTime @default(now())

  fichesResponsable    FicheDePaie[] @relation("ResponsableFiches")
  fichesCoordinateur   FicheDePaie[] @relation("CoordinateurFiches")
  fichesFormateur      FicheDePaie[] @relation("FormateurFiches")

  sessionsCoordinateur Session[]     @relation("CoordinateurSessions")
  sessionsFormateur    SessionFormateur[]

  @@index([email])
  @@index([role])
  @@index([cin])
  @@index([tel])
}

model FicheDePaie {
  id             Int      @id @default(autoincrement())
  numMemoire     String   @unique @db.VarChar(100)
  nomResponsable String   @db.VarChar(200)
  periode        String   @db.VarChar(150)
  etat           EtatFiche @default(EN_ATTENTE)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  typeFiche      TypeFiche @default(FORMATION)
  sessionId      Int?     
  coordinateurId Int?
  formateurId    Int?     

  montantTotalBrut   Float?   
  montantTotalNet    Float?   
  totalRegroupement Int?
  totalTutorat      Int?
  
  // Relations
  session     Session? @relation("SessionFiches", fields: [sessionId], references: [id], onDelete: Cascade)
  coordinateur User?   @relation("CoordinateurFiches", fields: [coordinateurId], references: [id], onDelete: Cascade)
  formateur    User?   @relation("FormateurFiches", fields: [formateurId], references: [id], onDelete: Cascade)
  responsable  User    @relation("ResponsableFiches", fields: [responsableId], references: [id], onDelete: Cascade)
  
  responsableId Int
  
  // Relation avec les sessions (pour mémoires de règlement)
  sessions     Session[] @relation("FicheSessions")

  @@index([responsableId])
  @@index([coordinateurId])
  @@index([formateurId])
  @@index([sessionId])
  @@index([numMemoire])
  @@index([typeFiche])
  @@index([etat])
}

// Enum pour les types de fiches
enum TypeFiche {
  FORMATION
  COORDINATION
  REGLEMENT
}

// Enum pour les états des fiches
enum EtatFiche {
  EN_ATTENTE
  VALIDE
}

model Session {
  id          Int      @id @default(autoincrement())
  titre       String   @db.VarChar(255)
  specialite String?   @db.VarChar(150)
  dateDebut   DateTime
  dateFin     DateTime
  classe      String?  @db.VarChar(50)
  promotion   String?    @db.VarChar(50)
  niveau      String?  @db.VarChar(50)
  semestre    String?  @db.VarChar(50)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  formateurs  SessionFormateur[]

  coordinateurId Int?
  coordinateur   User? @relation("CoordinateurSessions", fields: [coordinateurId], references: [id], onDelete: SetNull)

  ficheId     Int?
  fiche       FicheDePaie? @relation("FicheSessions", fields: [ficheId], references: [id], onDelete: Cascade)

  // Relation one-to-many avec FicheDePaie
  fichesSession FicheDePaie[] @relation("SessionFiches")

  @@index([coordinateurId])
  @@index([ficheId])
  @@index([dateDebut])
}

model SessionFormateur {
  id          Int      @id @default(autoincrement())
  sessionId   Int
  formateurId Int

  session     Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  formateur   User     @relation(fields: [formateurId], references: [id], onDelete: Cascade)

  @@unique([sessionId, formateurId])
  @@index([formateurId])
}